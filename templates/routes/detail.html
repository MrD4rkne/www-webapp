{% extends "base.html" %}

{% block content %}
<div class="container mx-auto py-10">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">{{ route.name }}</h1>
    <div class="flex flex-col md:flex-row gap-6">
        <!-- Map Section -->
        <div class="flex-1">
            <img id="map" class="w-full h-96 rounded-lg shadow-lg object-cover" src="{{ route.image.image.url }}" alt="{{ route.name }}">
            {% load mathfilters %}
            {% for point in points %}
                <div class="w-4 h-4 bg-red-500 border-2 border-white rounded-full absolute point"
                style="left: {{ point.lat|div:route.image.image.width|mul:100 }}%; top: {{ point.lon|div:route.image.image.height|mul:100 }}%;"
                     data-pointId="{{ forloop.counter }}">
                    <span id="border-id" class="text-white text-xs font-bold"
                          style="position: absolute; top: -20px; left: -10px;">{{ forloop.counter }}</span>
                </div>
            {% endfor %}
        </div>
        <!-- Points List Section -->
        <div class="w-full md:w-1/3 bg-white shadow-lg rounded-lg p-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Route Points</h2>
            <ul class="space-y-2">
                {% for point in points %}
                <li class="p-2 border border-gray-300 rounded-lg point-item" data-pointId="{{ forloop.counter }}">
                    <p class="text-gray-700 font-medium">Point {{ forloop.counter }}</p>
                    <p class="text-sm text-gray-500">X: {{ point.lat }}</p>
                    <p class="text-sm text-gray-500">Y: {{ point.lon }}</p>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    // Draw points on the image
    const image = document.getElementById('map');

    // Handle double-click to create a new point
    image.addEventListener('dblclick', (event) => {
        const confirmCreate = confirm("Do you want to create a point here?");
        if (confirmCreate) {
            const rect = image.getBoundingClientRect();
            const xPercent = ((event.clientX - rect.left) / rect.width) * 100;
            const yPercent = ((event.clientY - rect.top) / rect.height) * 100;

            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/routes/{{ route.id }}/points/create`;

            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);

            // Add latitude and longitude inputs
            const latitudeInput = document.createElement('input');
            latitudeInput.type = 'hidden';
            latitudeInput.name = 'lat';
            latitudeInput.value = Math.round(xPercent);
            form.appendChild(latitudeInput);

            const longitudeInput = document.createElement('input');
            longitudeInput.type = 'hidden';
            longitudeInput.name = 'lon';
            longitudeInput.value = Math.round(yPercent);
            form.appendChild(longitudeInput);

            document.body.appendChild(form);
            form.submit();
        }
    });
</script>

<script>
  const dots = document.querySelectorAll('.point');
  const texts = document.querySelectorAll('.point-item');

  function setHover(id, hover) {
    const dot = document.querySelector(`.point[data-pointId="${id}"]`);
    const text = document.querySelector(`.point-item[data-pointId="${id}"]`);
    if (hover) {
      dot.classList.add('bg-blue-500');
      dot.classList.remove('bg-red-500');
      text.classList.add('border-blue-300');
      text.classList.remove('border-gray-300');
    } else {
      dot.classList.remove('bg-blue-500');
      dot.classList.add('bg-red-500');
      text.classList.remove('border-blue-300');
      text.classList.add('border-gray-300');
    }
  }

  [...dots, ...texts].forEach(el => {
    el.addEventListener('mouseenter', () => setHover(el.dataset.pointid, true));
    el.addEventListener('mouseleave', () => setHover(el.dataset.pointid, false));
  });
</script>
{% endblock %}